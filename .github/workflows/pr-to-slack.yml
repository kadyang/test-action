name: PR to Slack

on:
    pull_request_target:
        types: [labeled]

jobs:
    slackNotification:
        if: ${{ github.event.label.name == 'ğŸ‘€  Needs Review' }}
        name: Slack Notification
        runs-on: ubuntu-latest
        steps:
            - name: Extract PR Description and convert img tags
              id: extract-and-convert
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                  PR_DESCRIPTION=$(jq -r .pull_request.body < "$GITHUB_EVENT_PATH")
                  
                  # åƒ…æ“·å–åˆ° jira link
                  PR_DESCRIPTION=$(echo "$PR_DESCRIPTION" | perl -0777 -ne 'print $1 if /(## Service Name\s*.*https:\/\/kkday\.atlassian\.net\/.*?\n)/s')
                  
                  # ç½®æ› <img> æ¨™ç±¤ä¸¦è½‰æ›ç‚º Slack æ”¯æŒçš„æ ¼å¼
                  PR_DESCRIPTION=$(echo "$PR_DESCRIPTION" | perl -pe 's/<img[^>]+src="([^"]+)"[^>]*>/ <$1|image> /g')

                  # è™•ç†é›™å¼•è™Ÿç‚ºå–®å¼•è™Ÿ, æ›è¡Œç¬¦è™Ÿ, é¿å… slack api éŒ¯èª¤
                  PR_DESCRIPTION=$(echo "$PR_DESCRIPTION" | perl -pe 's/"/'\''/g' | perl -pe 's/\r\n/\\n/g; s/\n/\\n/g;') 
                  
                  # é€™é‚Šä¸èƒ½ä½¿ç”¨ set-output, çµæœè®Šæ•¸æœƒåªæœ‰ç¬¬ä¸€è¡Œ, è¦é€™æ¨£å¯«æ‰èƒ½æ¥å—å¤šè¡Œ
                  {
                    echo 'JSON_RESPONSE<<EOF'
                    echo $PR_DESCRIPTION
                    echo EOF
                  } >> "$GITHUB_OUTPUT"

            - name: Slack Notification
              uses: rtCamp/action-slack-notify@v2
              env:
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
                SLACK_USERNAME: é»å°é» Github Action
                SLACK_CUSTOM_PAYLOAD: '
                    {
                        "username": "é»å°é» Github Action æ©Ÿå™¨äºº",
                        "icon_emoji": ":chino-star:",
                        "blocks": [
                            {
                                "type": "header",
                                "text": {
                                    "type": "plain_text",
                                    "text": "æœ‰æ–°çš„ PR è«‹å¹«çœ‹ :pray:",
                                    "emoji": true
                                }
                            }
                        ],
                        "attachments": [
                            {
                                "color": "#AFE1AF",
                                "blocks": [
                                    {
                                        "type": "section",
                                        "fields": [
                                            {
                                                "type": "mrkdwn",
                                                "text": "*Creator*\n${{ github.event.pull_request.user.login }}"
                                            },
                                            {
                                                "type": "mrkdwn",
                                                "text": "*Label*\n${{ github.event.label.name }}"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "section",
                                        "fields": [
                                            {
                                                "type": "mrkdwn",
                                                "text": "*Title*\n${{ github.event.pull_request.title }}"
                                            },
                                            {
                                                "type": "mrkdwn",
                                                "text": "*Link*\n<${{ github.event.pull_request.html_url }}>"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "section",
                                        "fields": [
                                            {
                                                "type": "mrkdwn",
                                                "text": "*Message*\n${{ steps.extract-and-convert.outputs.JSON_RESPONSE }}"
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }'
