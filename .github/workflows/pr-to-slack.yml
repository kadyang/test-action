name: Slack Notification on Labeled PR
on:
  pull_request_target:
    types: [labeled]

jobs:
  send_to_slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract PR body and convert images to links
        id: extract_body
        run: |
          echo "::set-output name=body::$(jq -r .pull_request.body $GITHUB_EVENT_PATH | sed 's/!\[\]\([^]]*\)/[![Image](\1)](\1)/g')"

      - name: Send message to Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ steps.extract_body.outputs.body }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
              "text": "'"$PR_TITLE"'",
              "attachments": [
                {
                  "text": "'"$PR_BODY"'"
                }
              ]
            }' $SLACK_WEBHOOK
